//Include Libraries
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

//Define Display
#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels
#define OLED_RESET     -1 // Reset pin # (or -1 if sharing Arduino reset pin)
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

//Define Input / Output
#define startbtn D7           
#define lappot A0  
#define ledOrange 15           
#define ledRed1 1
#define ledRed2 16
#define ledRed3 0
#define ledRed4 2  
#define reedC1 14
#define reedC2 12
/* 
 *  D0, 
 *  D1 = 1        LED Red 1
 *  D2 = 16       LED Red 2
 *  D3, D4        Display
 *  D5 = 14       Taster Reed C2
 *  D6 = 12       Taster Reed C1
 *  D7 = 13       Taster Start/Stop
 *  D8 = 0        LED Red 3
 *  D9 = 2        Built-In LED Red 4
 *  D10 = 15      LED Orange
*/

void setup() {
  Serial.begin(115200);
  Serial.println("Ready");
  pinMode(lappot, INPUT);  
  pinMode(startbtn, INPUT);  
  pinMode(reedC1, INPUT);  
  pinMode(reedC2, INPUT);  
  pinMode(ledOrange, OUTPUT);
  pinMode(ledRed1, OUTPUT);
  pinMode(ledRed2, OUTPUT);
  pinMode(ledRed3, OUTPUT);
  pinMode(ledRed4, OUTPUT);

  //Initialize Display
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { // Address 0x3D for 128x64
    Serial.println(F("SSD1306 allocation failed"));
    for(;;); // Don't proceed, loop forever
  }            
  display.display();  
}

//#########   Setup   #########//
boolean runXTimes = true;
boolean startseq = false;
boolean systemReadyMsg = true;
boolean lapSet = false;
boolean raceMode = false;
boolean resultMode = false;
boolean finishMode = false;
boolean resultsShown = false;
boolean timingCar1Allowed = true;
boolean timingCar2Allowed = true;
int car1Rounds = -1;
int car2Rounds = -1;
int lapsNumOld = 999;
int lapconfig = 0;
int buttonStateSubmit = 0;
int lapsNum = 0;
int remainingLapsOld = 999;
int remainingLaps = 999;
int remainingLapsC1 = 999;
int remainingLapsC2 = 999;
unsigned long startTime;
unsigned long inputTime;
unsigned long nowTimeC1;
unsigned long lapTimeC1;
unsigned long lastTimeC1;
unsigned long nowTimeC2;
unsigned long lapTimeC2;
unsigned long lastTimeC2;
unsigned long inputTimeC1;
unsigned long inputTimeC2;
long lapTime = 0;
long lastTime = 0;
long previousMillis = 0;
long previousMillisC1 = 0;
long previousMillisC2 = 0;
const long trackDistance = 200;
const long interval = 1000; 
String displayMsg;
String leader;
String lastTrigger;

int ledArray[] = {15,1,16,0,2}; 
const int ledArraySize = sizeof(ledArray)/sizeof(ledArray[0]);
String countdown[5] = { "5", "4", "3", "2", "1"};

void printTime()
{
  unsigned long millisec  = inputTime % 100;
  unsigned long tseconds = lapTime / 1000;
  unsigned long tminutes = tseconds / 60;
  unsigned long seconds = tseconds % 60;
  Serial.print(tminutes);
  Serial.print(":");
  Serial.print(seconds);
  Serial.print(":");
  Serial.println(millisec);
};

void loop() {
  //Auslagern in Setup
  while(systemReadyMsg == true){
    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(20,10);
    display.println(F("Slotcar"));
    display.setCursor(20,30);
    display.println(F("Timing"));
    display.display();
    systemReadyMsg = false;
    delay(2000);
  };
 
  //Chose Distance via Poti (0-100 Rounds, 5 Steps)
  while(lapSet == false){
    //Debounce Button
    unsigned long currentMillis = millis();
    buttonStateSubmit = digitalRead(startbtn);
    if (currentMillis - previousMillis >= interval) {
      previousMillis = currentMillis;
      int lapPoti = analogRead(lappot);
      int m = map(lapPoti,0,1023,1,1000)/10;
      int lapsNum = ((m +4)/5)*5;
      if(lapsNumOld != lapsNum){
        display.clearDisplay();
        display.setTextSize(1);
        display.setTextColor(SSD1306_WHITE);
        display.setCursor(0,0);
        display.println(F("Choose Laps and"));
        display.println(F("Press Button"));
        display.setTextSize(2);
        display.setCursor(20,30);
        display.print(F("Laps: "));
        display.println(lapsNum);
        display.display();
        lapsNumOld = lapsNum;
      }; 
    };
    //Press Button to Start
    if ((buttonStateSubmit == HIGH) && (lapSet == false)) {
      lapconfig = lapsNumOld;
      display.clearDisplay();
      display.setTextSize(2);
      display.setTextColor(SSD1306_WHITE);
      display.setCursor(10,0);
      display.print(F("Laps = "));
      display.println(lapconfig);
      display.setTextSize(1);
      display.setCursor(0,40);
      display.print(F("Press Button to Start"));
      display.display();
      lapSet = true;
      delay(1500);
    };
    delay(0);
  };

  int lapTimesCar1[lapsNumOld];
  int lapTimeCar1Index = 0;
  int lapTimesCar2[lapsNumOld];
  int lapTimeCar2Index = 0;
  //Start Signal Sequence
  //Start Button Pushed and Startsequence not completed
  int buttonStateStart = digitalRead(startbtn);
  if ((buttonStateStart == HIGH) && (startseq == false) && (lapSet == true)) {
    while(startseq == false){
      //Start Signal
      digitalWrite(15, HIGH);
      display.clearDisplay();
      display.setTextSize(2);
      display.setTextColor(SSD1306_WHITE);
      display.setCursor(5,25);
      display.print(F("Get Ready!"));
      display.display();
      delay(4000); // Wait for 4s
      for (int i=0; i<ledArraySize; i++) {
          digitalWrite(ledArray[i], HIGH);
          display.clearDisplay();
          display.setTextSize(3);
          display.setTextColor(SSD1306_WHITE);
          display.setCursor(55,25);
          display.print(countdown[i]);
          display.display();
          delay(1000); // Wait for 1s
      };
      for (int i=0; i<ledArraySize; i++) {
          digitalWrite(ledArray[i], LOW);
      };
      display.clearDisplay();
      display.setTextSize(2);
      display.setTextColor(SSD1306_WHITE);
      display.setCursor(35,25);
      display.print(F("START!"));
      display.display();
      startTime = millis();
      lastTime = startTime;
      startseq = true;
      raceMode = true;
      buttonStateStart = 0;
    };
  };

  //Start Timing & Lap Counter
  //If in Racemode
  while(raceMode == true){  
    int buttonStateStop = digitalRead(startbtn);
    int car1Reed = digitalRead(reedC1);
    int car2Reed = digitalRead(reedC2);
    
    //Count Lap if Reed is triggered
    if((car1Reed == HIGH) && (timingCar1Allowed == true)){
      //Debounce Button
      unsigned long currentMillisC1 = millis();
      if (currentMillisC1 - previousMillisC1 >= interval) {
        //Lap Count
        car1Rounds++;
        lastTrigger = "car1";
        Serial.print("Lap: ");
        Serial.println(car1Rounds);
        if(remainingLaps == 1 && car1Rounds > car2Rounds){
          remainingLaps = 0;
        };
        //Lap Time
        nowTimeC1 = millis();
        lapTimeC1 = (nowTimeC1 - lastTime); 
        lastTimeC1 = nowTimeC1; 
        previousMillisC1 = nowTimeC1;
        lapTimesCar1[lapTimeCar1Index++] = lapTimeC1;
        timingCar1Allowed = false;
        Serial.print("Laptime C1: ");
        inputTime = lapTimeC1;
        printTime();
      };
    };
    if((car2Reed == HIGH) && (timingCar2Allowed == true)){
      //Debounce Button
      unsigned long currentMillisC2 = millis();
      if (currentMillisC2 - previousMillisC2 >= interval) {
        //Lap Count
        car2Rounds++;
        lastTrigger = "car2";
        Serial.print("Lap: ");
        Serial.println(car2Rounds);
        if(remainingLaps == 1 && car2Rounds > car1Rounds){
          remainingLaps = 0;
        };
        //Lap Time
        nowTimeC2 = millis();
        lapTimeC2 = (nowTimeC2 - lastTimeC2); 
        lastTimeC2 = nowTimeC2; 
        previousMillisC2 = nowTimeC2;
        lapTimesCar2[lapTimeCar2Index++] = lapTimeC2;
        timingCar1Allowed = false;
        Serial.print("Laptime C2: ");
        inputTime = lapTimeC2;
        printTime();
      };
    };
    //Round doesn't count if a car stand still on Start
    if((car1Reed == LOW) && (timingCar1Allowed == false)){
      timingCar1Allowed = true;
    };
    if((car2Reed == LOW) && (timingCar2Allowed == false)){
      timingCar2Allowed = true;
    };
    //Remaining Laps Calculation   
    if(remainingLaps > 1){
      if(car1Rounds > car2Rounds){
        remainingLaps = lapconfig - car1Rounds;
      }else{
        remainingLaps = lapconfig - car2Rounds;
      };
    };
    //Calculate Leading Car 
    if(car1Rounds > car2Rounds){
      leader = "Car 1";
    }else if(car1Rounds < car2Rounds){
      leader = "Car 2";
    }else{
      if(lastTrigger == "car2"){
        leader = "Car 1";
      }else{
        leader = "Car 2";
      }
    };
    if(remainingLaps < remainingLapsOld){
        display.clearDisplay();
        display.setTextSize(1);
        display.setTextColor(SSD1306_WHITE);
        display.setCursor(0,0);
        display.println(F("Laps to Go: "));
        display.setTextSize(2);
        display.println(remainingLaps);
        display.setCursor(0,30);
        display.println(F("Leader:"));
        display.setTextSize(2);
        display.println(leader);
        display.display();
        remainingLapsOld = remainingLaps;
    };
      
    //Last Lap or Start Button pushed again
    if((buttonStateStop == HIGH && finishMode == false) || (remainingLaps == 1 && finishMode == false)){
      finishMode = true; 
      //Set LEDs to Orange
      digitalWrite(ledOrange, HIGH);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(SSD1306_WHITE);
      display.setCursor(0,0);
      display.println(F("LAST LAP!"));
      display.setTextSize(2);
      display.setCursor(0,30);
      display.println(F("Leader:"));
      display.setTextSize(2);
      display.println(leader);
      display.display();
      //Set Remaining Laps to 1
      remainingLaps = 1;
    };
    //Last Lap is Completed
    if(remainingLaps == 0){
      //Set LEDs to RED/STOP after last lap
      for (int i=0; i<ledArraySize; i++) {
          digitalWrite(ledArray[i], HIGH);
      };
      //Leave Racemode
      raceMode = false;
      resultMode = true;
      buttonStateStop = 0;
    };
    delay(0);
  };
}
